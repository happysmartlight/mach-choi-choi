<!DOCTYPE html>
<html lang="en">
<head>
	<meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" name="viewport">
	<meta charset="utf-8">
	<title>Cài đặt Bảo mật & Cập nhật</title>
	<style> html { visibility: hidden; } </style> <!-- prevent white & ugly display while loading, unhidden in loadResources() -->
	<script>
		// load common.js with retry on error
		(function loadFiles() {
			const l = document.createElement('script');
			l.src = 'common.js';
			l.onload = () => loadResources(['style.css'], S); // load style.css then call S()
			l.onerror = () => setTimeout(loadFiles, 100);
			document.head.appendChild(l);
		})();
		function U() { window.open(getURL("/update"),"_self"); }
		function checkNum(o) {
			const specialkeys = ["Backspace", "Tab", "Enter", "Shift", "Control", "Alt", "Pause", "CapsLock", "Escape", "Space", "PageUp", "PageDown", "End", "Home", "ArrowLeft", "ArrowUp", "ArrowRight", "ArrowDown", "Insert", "Delete"];
			// true if key is a number or a special key
			if(event.key.match(/[0-9]/) || specialkeys.includes(event.key)) return true;
			event.preventDefault();
			return false;
		}
		function setBckFilename(x) {
			x.setAttribute("download","HSL_ARGB_" + x.getAttribute("download") + (sd=="WLED"?"":("_" +sd)));
		}
		function S() {
			getLoc();
			if (loc) {
				gId("bckcfg").setAttribute('href',getURL(gId("bckcfg").pathname));
				gId("bckpresets").setAttribute('href',getURL(gId("bckpresets").pathname));
			}
			loadJS(getURL('/settings/s.js?p=6'), false, undefined, ()=>{
				setBckFilename(gId("bckcfg"));
				setBckFilename(gId("bckpresets"));
			});	// If we set async false, file is loaded and executed, then next statement is processed
			if (loc) d.Sf.action = getURL('/settings/sec');
		}
	</script>
</head>
<body>
	<form id="form_s" name="Sf" method="post">
		<div class="toprow">
		<!-- <div class="helpB"><button type="button" onclick="H('features/settings/#security-settings')">?</button></div> -->
		<button type="button" onclick="B()">Quay lại</button><button type="submit">Lưu</button><hr>
		</div>
		<h2>Cài đặt Bảo mật & Cập nhật</h2>
		<div class="warn">&#9888; Bỏ trống và Lưu nếu không muốn sử dụng mã PIN!</div>
		<label for="PIN" style="font-weight:bold; color:#e0e0e0;">Mã PIN cài đặt:</label>
		<input
		type="password"
		id="PIN"
		name="PIN"
		size="6"
		maxlength="4"
		minlength="4"
		onkeydown="checkNum(this)"
		pattern="[0-9]*"
		inputmode="numeric"
		title="Vui lòng nhập mã gồm 4 chữ số"
		style="
			letter-spacing: 0.5em;
			text-align: center;
			font-size: 1.3em;
			padding: 8px 16px;
			border: 1px solid #555;
			border-radius: 8px;
			width: 220px; /* Tăng chiều rộng */
			box-sizing: border-box;
			margin: 8px 0 12px 8px;
			background: #1e1e2a;
			color: #e0e0e0;
			transition: border-color 0.2s, box-shadow 0.2s;
		"
		onfocus="this.style.borderColor='#3498db'; this.style.boxShadow='0 0 8px rgba(52,152,219,0.5)';"
		onblur="this.style.borderColor='#555'; this.style.boxShadow='none';"
		/>
		<br>

		<div class="warn">&#9888; Truyền tải không mã hóa. Hãy cẩn trọng khi chọn mã PIN, KHÔNG sử dụng mã PIN ngân hàng, cửa, SIM, v.v.!</div><br>
		Khóa cập nhật phần mềm không dây (OTA): <input type="checkbox" name="NO"><br>
		Mật khẩu OTA: <input type="password" name="OP" maxlength="32"><br>
		Để bật OTA, vì lý do bảo mật bạn cần nhập đúng mật khẩu!<br>
		Nên thay đổi mật khẩu khi bật OTA.<br>
		<b>Hãy tắt OTA khi không sử dụng, nếu không kẻ tấn công có thể nạp lại phần mềm thiết bị!</b><br>
		<i>Các cài đặt trên trang này chỉ có thể thay đổi nếu OTA chưa bị khóa!</i><br>
		Từ chối truy cập cài đặt WiFi nếu đã khóa: <input type="checkbox" name="OW"><br><br>
		
		<h3>Đặt lại thiết bị</h3>
		Khôi phục cài đặt gốc: <input type="checkbox" name="RS"><br>
		<div class="warn">&#9888; Tất cả cài đặt và preset sẽ bị xóa.<br><br>
		
		<div class="warn">&#9888; Truyền tải không mã hóa. Kẻ tấn công cùng mạng có thể chặn dữ liệu biểu mẫu!</div>
		<span id="OTA"><hr>
		<h3>Cập nhật phần mềm</h3>
		<button type="button" onclick="U()">Cập nhật OTA thủ công</button><br>
		<div id="aOTA">Bật ArduinoOTA: <input type="checkbox" name="AO"></div>
		Chỉ cho phép cập nhật từ cùng mạng/WiFi: <input type="checkbox" name="SU"><br>
		<i class="warn">&#9888; Nếu bạn sử dụng nhiều VLAN (ví dụ: mạng IoT hoặc khách), hãy đặt mã PIN hoặc tắt tùy chọn này.<br>
			Tắt tùy chọn này sẽ làm thiết bị của bạn kém an toàn hơn.</i><br></span>
		<hr id="backup">
		<h3>Sao lưu & Khôi phục</h3>
		<div class="warn">&#9888; Khôi phục preset/cấu hình sẽ GHI ĐÈ preset/cấu hình hiện tại của bạn.<br>
		Tải lên sai hoặc cấu hình không đúng có thể yêu cầu đặt lại thiết bị hoặc nạp lại firmware cho ESP.<br>
		Vì lý do bảo mật, mật khẩu sẽ không được sao lưu.</div>
		<a class="btn lnk" id="bckcfg" href="/presets.json" download="presets">Sao lưu preset</a><br>
		<div>Khôi phục preset<br><input type="file" name="data" accept=".json"> <button type="button" onclick="uploadFile(d.Sf.data,'/presets.json');">Tải lên</button><br></div><br>
		<a class="btn lnk" id="bckpresets" href="/cfg.json" download="cfg">Sao lưu cấu hình</a><br>
		<div>Khôi phục cấu hình<br><input type="file" name="data2" accept=".json"> <button type="button" onclick="uploadFile(d.Sf.data2,'/cfg.json');">Tải lên</button><br></div>
		<hr>

		<div id="toast"></div>
		<button type="button" onclick="B()">Quay lại</button><button type="submit">Lưu</button>
	</form>
</body>
</html>
