<!DOCTYPE html>
<html lang="en">
<head>
	<meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" name="viewport">
	<meta charset="utf-8">
	<title>Time Settings</title>
	<style> html { visibility: hidden; } </style> <!-- prevent white & ugly display while loading, unhidden in loadResources() -->
	<script>
	var el=false;
	var ms=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
	// load common.js with retry on error
	(function loadFiles() {
		const l = document.createElement('script');
		l.src = 'common.js';
		l.onload = () => loadResources(['style.css'], S); // load style.css then call S()
		l.onerror = () => setTimeout(loadFiles, 100);
		document.head.appendChild(l);
	})();

	function S() {
		getLoc();
		loadJS(getURL('/settings/s.js?p=5'), false, ()=>{BTa();}, ()=>{
			updLatLon();
			Cs();
			FC();
		});	// If we set async false, file is loaded and executed, then next statement is processed
		if (loc) d.Sf.action = getURL('/settings/time');
	}
	function expand(o,i)
	{
		var t = gId("WD"+i);
		t.style.display = t.style.display!=="none" ? "none" : "";
		o.innerHTML = t.style.display==="none" ? "&#128197;" : "&#x2715;";
	}
	function Cs() { gId("cac").style.display=(gN("OL").checked)?"block":"none"; }
	function BTa()
	{
		var ih="<thead><tr><th>En.</th><th>Hour</th><th>Minute</th><th>Preset</th><th></th></tr></thead>";
		for (i=0;i<8;i++) {
			ih+=`<tr><td><input name="W${i}" id="W${i}" type="hidden"><input id="W${i}0" type="checkbox"></td>
<td><input name="H${i}" class="xs" type="number" min="0" max="24"></td>
<td><input name="N${i}" class="xs" type="number" min="0" max="59"></td>
<td><input name="T${i}" class="s" type="number" min="0" max="250"></td>
<td><div id="CB${i}" onclick="expand(this,${i})" class="cal">&#128197;</div></td></tr>`;
			ih+=`<tr><td colspan=5><div id="WD${i}" style="display:none;background-color:#444;"><hr>Run on weekdays`;
			ih+=`<table><tr><th>M</th><th>T</th><th>W</th><th>T</th><th>F</th><th>S</th><th>S</th></tr><tr>`
			for (j=1;j<8;j++) ih+=`<td><input id="W${i}${j}" type="checkbox"></td>`;
			ih+=`</tr></table>from <select name="M${i}">`;
			for (j=0;j<12;j++) ih+=`<option value="${j+1}">${ms[j]}</option>`;
			ih+=`</select><input name="D${i}" class="xs" type="number" min="1" max="31"></input> to <select name="P${i}">`;
			for (j=0;j<12;j++) ih+=`<option value="${j+1}">${ms[j]}</option>`;
			ih+=`</select><input name="E${i}" class="xs" type="number" min="1" max="31"></input>
		<hr></div></td></tr>`;
		}
		ih+=`<tr><td><input name="W8" id="W8" type="hidden"><input id="W80" type="checkbox"></td>
<td>Sunrise<input name="H8" value="255" type="hidden"></td>
<td><input name="N8" class="xs" type="number" min="-59" max="59"></td>
<td><input name="T8" class="s" type="number" min="0" max="250"></td>
<td><div id="CB8" onclick="expand(this,8)" class="cal">&#128197;</div></td></tr><tr><td colspan=5>`;
		ih+=`<div id="WD8" style="display:none;background-color:#444;"><hr><table><tr><th>M</th><th>T</th><th>W</th><th>T</th><th>F</th><th>S</th><th>S</th></tr><tr>`;
		for (j=1;j<8;j++) ih+=`<td><input id="W8${j}" type="checkbox"></td>`;
		ih+="</tr></table><hr></div></td></tr>";
		ih+=`<tr><td><input name="W9" id="W9" type="hidden"><input id="W90" type="checkbox"></td>
<td>Sunset<input name="H9" value="255" type="hidden"></td>
<td><input name="N9" class="xs" type="number" min="-59" max="59"></td>
<td><input name="T9" class="s" type="number" min="0" max="250"></td>
<td><div id="CB9" onclick="expand(this,9)" class="cal">&#128197;</div></td></tr><tr><td colspan=5>`;
		ih+=`<div id="WD9" style="display:none;background-color:#444;"><hr><table><tr><th>M</th><th>T</th><th>W</th><th>T</th><th>F</th><th>S</th><th>S</th></tr><tr>`;
		for (j=1;j<8;j++) ih+=`<td><input id="W9${j}" type="checkbox"></td>`;
		ih+="</tr></table><hr></div></td></tr>";
		gId("TMT").innerHTML=ih;
	}
	function FC()
	{
		for(i=0;i<10;i++)
		{
			let wd = gId("W"+i).value;
			for(j=0;j<8;j++) {
				gId("W"+i+j).checked=wd>>j&1;
			}
			if ((wd&254) != 254 || (i<8 && (gN("M"+i).value != 1 || gN("D"+i).value != 1 || gN("P"+i).value != 12 || gN("E"+i).value != 31))) {
				expand(gId("CB"+i),i); //expand macros with custom DOW or date range set
			}
		}
	}
	function Wd()
	{
		a = [0,0,0,0,0,0,0,0,0,0];
		for (i=0; i<10; i++) {
			m=1;
			for(j=0;j<8;j++) { a[i]+=gId(("W"+i)+j).checked*m; m*=2;}
			gId("W"+i).value=a[i];
		}
		if (d.Sf.LTR.value==="S") { d.Sf.LT.value = -1*parseFloat(d.Sf.LT.value); }
		if (d.Sf.LNR.value==="W") { d.Sf.LN.value = -1*parseFloat(d.Sf.LN.value); }
	}
	function addRow(i,p,l,d) {
		var t = gId("macros");	// table
		var rCnt = t.rows.length;   // get the number of rows.
		var tr = t.insertRow(rCnt); // table row.
		var b = String.fromCharCode((i<10?48:55)+i);
		var td = document.createElement('td');          // TABLE DEFINITION.
		td = tr.insertCell(0);
		td.innerHTML = `Button ${i}:`;
		td = tr.insertCell(1);
		td.innerHTML = `<input name="MP${b}" type="number" class="s" min="0" max="250" value="${p}" required>`;
		td = tr.insertCell(2);
		td.innerHTML = `<input name="ML${b}" type="number" class="s" min="0" max="250" value="${l}" required>`;
		td = tr.insertCell(3);
		td.innerHTML = `<input name="MD${b}" type="number" class="s" min="0" max="250" value="${d}" required>`;
	}
	function getLatLon() {
		if (!el) {
			window.addEventListener("message", (event) => {
				if (event.origin !== "https://locate.wled.me") return;
				if (event.data instanceof Object) {
					d.Sf.LT.value = event.data.lat;
					d.Sf.LN.value = event.data.lon;
					updLatLon();
				}
			}, false);
			el = true;
		}
		window.open("https://locate.wled.me","_blank");
	}
	function updLatLon(i) {
		if (parseFloat(d.Sf.LT.value)<0) { d.Sf.LTR.value = "S"; d.Sf.LT.value = -1*parseFloat(d.Sf.LT.value); } else d.Sf.LTR.value = "N";
		if (parseFloat(d.Sf.LN.value)<0) { d.Sf.LNR.value = "W"; d.Sf.LN.value = -1*parseFloat(d.Sf.LN.value); } else d.Sf.LNR.value = "E";
	}
	</script>
	<style>@import url("style.css");</style>
</head>
<body>
	<form id="form_s" name="Sf" method="post" onsubmit="Wd()">
		<div class="toprow">
		<!-- <div class="helpB"><button type="button" onclick="H('features/settings/#time-settings')">?</button></div> -->
		<button type="button" onclick="B()">Quay lại</button><button type="submit">Lưu</button><hr>
		</div>
		<h2>Cài đặt thời gian</h2>
		Lấy thời gian từ máy chủ NTP: <input type="checkbox" name="NT"><br>
		<input type="text" name="NS" maxlength="32"><br>
		Sử dụng định dạng 24h: <input type="checkbox" name="CF"><br>
		Múi giờ: 
		<select name="TZ">
			<option value="0" selected>VIỆT NAM</option>
			<option value="1">GMT/BST</option>
		</select><br>
		Độ lệch UTC: <input name="UO" type="number" min="-65500" max="65500" required> giây (tối đa 18 giờ)<br>
		Thời gian địa phương hiện tại là <span class="times">unknown</span>.<br>
		Vĩ độ: <select name="LTR"><option value="N">Bắc</option><option value="S">Nam</option></select><input name="LT" type="number" class="xl" min="0" max="66.6" step="0.01"><br>
		Kinh độ: <select name="LNR"><option value="E">Đông</option><option value="W">Tây</option></select><input name="LN" type="number" class="xl" min="0" max="180" step="0.01"><br>
		<button type="button" id="locbtn" onclick="getLatLon()">Lấy vị trí</button>
		<div><i>(mở tab mới, chỉ hoạt động trong trình duyệt)</i></div>
		<div id="sun" class="times"></div>
		<div style="background:#0a0f1a;color:#e0e0e0;padding:20px;border-radius:12px;">

		<i style="color:#ff8ed6;">
			Đồng hồ digital: sử dụng "Scrolling Text": 
			<b>#DATE0, #TIME, #DDMM, #MMDD, #HHMM, #HH, #MM;</b>
		</i><br>

		<div style="padding:15px;">

			<div style="
			display:grid;
			grid-template-columns:repeat(auto-fit,minmax(200px,1fr));
			gap:10px;
			text-align:left;
			">

			<!-- Item -->
			<div style="padding:10px 14px;background:rgba(0,255,255,0.06);border:1px solid rgba(0,255,255,0.3);border-radius:10px;">
				<a href="#" class="tk" data-t="#TIME" style="color:#00eaff;font-weight:bold;text-decoration:none;">#TIME</a> - HH:MM AM/PM
			</div>

			<div style="padding:10px 14px;background:rgba(0,255,255,0.06);border:1px solid rgba(0,255,255,0.3);border-radius:10px;">
				<a href="#" class="tk" data-t="#HHMM" style="color:#00eaff;font-weight:bold;text-decoration:none;">#HHMM</a> - HH:MM
			</div>

			<div style="padding:10px 14px;background:rgba(0,255,255,0.06);border:1px solid rgba(0,255,255,0.3);border-radius:10px;">
				<a href="#" class="tk" data-t="#DATE" style="color:#00eaff;font-weight:bold;text-decoration:none;">#DATE</a> - DD.MM.YYYY
			</div>

			<div style="padding:10px 14px;background:rgba(0,255,255,0.06);border:1px solid rgba(0,255,255,0.3);border-radius:10px;">
				<a href="#" class="tk" data-t="#DDMM" style="color:#00eaff;font-weight:bold;text-decoration:none;">#DDMM</a> - Day.Month
			</div>

			<div style="padding:10px 14px;background:rgba(0,255,255,0.06);border:1px solid rgba(0,255,255,0.3);border-radius:10px;">
				<a href="#" class="tk" data-t="#MMDD" style="color:#00eaff;font-weight:bold;text-decoration:none;">#MMDD</a> - Month/Day
			</div>

			<div style="padding:10px 14px;background:rgba(0,255,255,0.06);border:1px solid rgba(0,255,255,0.3);border-radius:10px;">
				<a href="#" class="tk" data-t="#YYYY" style="color:#00eaff;font-weight:bold;text-decoration:none;">#YYYY</a> - Year
			</div>

			<div style="padding:10px 14px;background:rgba(0,255,255,0.06);border:1px solid rgba(0,255,255,0.3);border-radius:10px;">
				<a href="#" class="tk" data-t="#YY" style="color:#00eaff;font-weight:bold;text-decoration:none;">#YY</a> - Year 2-digit
			</div>

			<div style="padding:10px 14px;background:rgba(0,255,255,0.06);border:1px solid rgba(0,255,255,0.3);border-radius:10px;">
				<a href="#" class="tk" data-t="#HH" style="color:#00eaff;font-weight:bold;text-decoration:none;">#HH</a> - Hours
			</div>

			<div style="padding:10px 14px;background:rgba(0,255,255,0.06);border:1px solid rgba(0,255,255,0.3);border-radius:10px;">
				<a href="#" class="tk" data-t="#MM" style="color:#00eaff;font-weight:bold;text-decoration:none;">#MM</a> - Minutes
			</div>

			<div style="padding:10px 14px;background:rgba(0,255,255,0.06);border:1px solid rgba(0,255,255,0.3);border-radius:10px;">
				<a href="#" class="tk" data-t="#SS" style="color:#00eaff;font-weight:bold;text-decoration:none;">#SS</a> - Seconds
			</div>

			<div style="padding:10px 14px;background:rgba(0,255,255,0.06);border:1px solid rgba(0,255,255,0.3);border-radius:10px;">
				<a href="#" class="tk" data-t="#MO" style="color:#00eaff;font-weight:bold;text-decoration:none;">#MO</a> - Month number
			</div>

			<div style="padding:10px 14px;background:rgba(0,255,255,0.06);border:1px solid rgba(0,255,255,0.3);border-radius:10px;">
				<a href="#" class="tk" data-t="#DD" style="color:#00eaff;font-weight:bold;text-decoration:none;">#DD</a> - Day number
			</div>

			<div style="padding:10px 14px;background:rgba(0,255,255,0.06);border:1px solid rgba(0,255,255,0.3);border-radius:10px;">
				<a href="#" class="tk" data-t="#MON" style="color:#00eaff;font-weight:bold;text-decoration:none;">#MON</a> - Month (Jan)
			</div>

			<div style="padding:10px 14px;background:rgba(0,255,255,0.06);border:1px solid rgba(0,255,255,0.3);border-radius:10px;">
				<a href="#" class="tk" data-t="#MONL" style="color:#00eaff;font-weight:bold;text-decoration:none;">#MONL</a> - Month (January)
			</div>

			<div style="padding:10px 14px;background:rgba(0,255,255,0.06);border:1px solid rgba(0,255,255,0.3);border-radius:10px;">
				<a href="#" class="tk" data-t="#DAY" style="color:#00eaff;font-weight:bold;text-decoration:none;">#DAY</a> - Weekday (Mon)
			</div>

			<div style="padding:10px 14px;background:rgba(0,255,255,0.06);border:1px solid rgba(0,255,255,0.3);border-radius:10px;">
				<a href="#" class="tk" data-t="#DDDD" style="color:#00eaff;font-weight:bold;text-decoration:none;">#DDDD</a> - Weekday (Monday)
			</div>

			</div>

			<div style="margin:10px;padding-top:10px;border-top:1px solid #444;color:#ff8ed6;">
			<strong>Tips:</strong><br>
			• Mix văn bản & token: <span style="color:#00eaff">\"It's #HHMM O'Clock\"</span><br>
			• Leading zero: <span style="color:#00eaff">#TIME0, #HH0</span>, v.v.
			</div>

		</div>
		</div>
		
		
		<h3>Đồng hồ kim</h3>
		Đồng hồ kim: <input type="checkbox" name="OL" onchange="Cs()"><br>
		<div id="cac">
			Bắt đầu tại LED: <input name="O1" type="number" min="0" max="1024" required> Kết thúc tại LED: <input name="O2" type="number" min="0" max="1024" required><br>
			12h LED: <input name="OM" type="number" min="0" max="1024" required><br>
			Show 5min marks: <input type="checkbox" name="O5"><br>
			Giây (as trail): <input type="checkbox" name="OS"><br>
			Show clock overlay only if all LEDs are solid black: <input type="checkbox" name="OB"><br>
		</div>
		Countdown Mode: <input type="checkbox" name="CE"><br>
		Countdown Goal:<br>
		Date:&nbsp;<nowrap>20<input name="CY" class="xs" type="number" min="0" max="99" required>-<input name="CI" class="xs" type="number" min="1" max="12" required>-<input name="CD" class="xs" type="number" min="1" max="31" required></nowrap><br>
		Time:&nbsp;<nowrap><input name="CH" class="xs" type="number" min="0" max="23" required>:<input name="CM" class="xs" type="number" min="0" max="59" required>:<input name="CS" class="xs" type="number" min="0" max="59" required></nowrap><br>
		<h3>Macro presets</h3>
		<b>Macros have moved!</b><br>
		<i>Các preset giờ đây cũng có thể được dùng như macro để lưu cả lệnh JSON và lệnh HTTP API.<br>
		Chỉ cần nhập ID preset bên dưới!</i>
		<i>Sử dụng 0 cho hành động mặc định thay vì preset</i><br>
		Preset bật/tắt Alexa: <input name="A0" class="m" type="number" min="0" max="250" required> <input name="A1" class="m" type="number" min="0" max="250" required><br>
		Preset khi kết thúc đếm ngược: <input name="MC" class="m" type="number" min="0" max="250" required><br>
		Preset khi kết thúc đèn theo thời gian: <input name="MN" class="m" type="number" min="0" max="250" required><br>
		<h3>Hành động nút</h3>
		<table style="margin: 0 auto;" id="macros">
			<thead>
				<tr>
					<td>push<br>switch</td>
					<td>short<br>on-&gt;off</td>
					<td>long<br>off-&gt;on</td>
					<td>double<br>N/A</td>
				</tr>
			</thead>
			<tbody>
			</tbody>
		</table>
		<a href="https://kno.wled.ge/features/macros/#analog-button" target="_blank">Analog Button setup</a>
		<h3>Time-controlled presets</h3>
		<div style="display: inline-block">
		<table id="TMT" style="min-width:330px;"></table>
		</div>
		<hr>
		<button type="button" onclick="B()">Quay lại</button><button type="submit">Lưu</button>
	</form>
</body>
</html>
